---
import '../styles/global.css';
import { ViewTransitions } from 'astro:transitions';
import Analytics from '@vercel/analytics/astro';

export interface Props {
  title: string;
  description: string;
  date: Date;
  tags?: string[];
  wordCount?: number;
  headings: { depth: number; slug: string; text: string }[];
}

const { title, description, date, tags = [], wordCount, headings } = Astro.props;

// Filter to h2 headings for TOC sidebar
const tocItems = headings.filter(h => h.depth === 2);

// Get the first tag as "category" for breadcrumb
const category = tags.length > 0 ? tags[0].toUpperCase() : 'BLOG';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} - Yuvraj Biswal</title>
    <ViewTransitions />
    <Analytics mode="production"/>
  </head>
  <body class="min-h-screen">
    <!-- Fixed breadcrumb nav (top-left, like reference) -->
    <div class="blog-breadcrumb" id="blog-breadcrumb">
      <a href="/blog" class="bc-arrow" title="Back">‹</a>
      <a href="/blog" class="bc-arrow" title="Forward">›</a>
      <a href="/blog">{category}</a>
      <span class="bc-separator">/</span>
      <span class="bc-current">{title.length > 40 ? title.slice(0, 40) + '…' : title}</span>
    </div>

    <!-- Settings icon (top-right, like reference) -->
    <svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="3"></circle>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
    </svg>

    <!-- Scroll progress: thin track + numeric indicator -->
    <div class="scroll-track" id="scroll-track">
      <div class="scroll-track-fill" id="scroll-track-fill"></div>
    </div>
    <div class="scroll-position" id="scroll-position">0.00</div>

    <!-- Right-side TOC with dash lines -->
    {tocItems.length > 0 && (
      <nav class="toc-sidebar" id="toc-sidebar" aria-label="Table of contents">
        {tocItems.map((item) => (
          <a href={`#${item.slug}`} class="toc-item" data-slug={item.slug}>
            <span class="toc-item-text">{item.text}</span>
          </a>
        ))}
      </nav>
    )}

    <!-- Image Lightbox -->
    <div class="lightbox-overlay" id="lightbox">
      <button class="lightbox-exit" id="lightbox-exit">EXIT</button>
      <img id="lightbox-img" src="" alt="" />
      <div class="lightbox-caption" id="lightbox-caption"></div>
    </div>

    <!-- Article content area -->
    <div class="max-w-[680px] mx-auto px-6 pt-16 pb-16">
      <main>
        <!-- Article Header -->
        <header class="mb-14 mt-8">
          <div class="blog-meta mb-5 flex items-center justify-center gap-2">
            {wordCount && <span>{wordCount.toLocaleString()} words</span>}
            {wordCount && <span>|</span>}
            <span>Yuvraj Biswal</span>
          </div>

          <h1 class="text-[2.125rem] leading-[1.2] font-semibold text-[var(--slate-900)] text-center mb-4" style="font-family: var(--font-heading); letter-spacing: -0.02em;">
            {title}
          </h1>

          <p class="text-[var(--text-secondary)] text-center text-[1.0625rem] leading-relaxed max-w-lg mx-auto">
            {description}
          </p>

          <div class="flex justify-center mt-6 mb-10">
            <span class="block w-12 h-px bg-[var(--slate-200)]"></span>
          </div>
        </header>

        <!-- Article Content -->
        <article class="prose prose-slate max-w-none" id="article-content">
          <slot />
        </article>

        <!-- Tags -->
        {tags.length > 0 && (
          <div class="mt-14 pt-8 border-t border-[var(--border-color)]">
            <div class="flex flex-wrap gap-2">
              {tags.map((tag) => (
                <span class="mono px-3 py-1.5 bg-[var(--slate-50)] border border-[var(--border-color)] rounded" style="font-size: 0.625rem;">
                  {tag}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Back to blog -->
        <div class="mt-10">
          <a href="/blog" class="mono text-[var(--text-muted)] hover:text-[var(--slate-600)] transition-colors" style="text-decoration: none; font-size: 0.6875rem;">
            ← Back to all posts
          </a>
        </div>
      </main>

      <!-- Footer -->
      <footer class="mt-24 pt-8 border-t border-[var(--border-color)] text-center text-sm text-[var(--text-muted)]">
        <p>© 2026 Yuvraj Biswal</p>
      </footer>
    </div>

    <script>
      // ---- Scroll progress: track fill + numeric position ----
      function updateScrollProgress() {
        const fill = document.getElementById('scroll-track-fill');
        const pos = document.getElementById('scroll-position');
        if (!fill || !pos) return;

        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const progress = docHeight > 0 ? scrollTop / docHeight : 0;

        fill.style.height = `${progress * 100}%`;
        pos.textContent = progress.toFixed(2);
      }

      // ---- TOC active state tracking ----
      function updateActiveTOC() {
        const tocItems = document.querySelectorAll('.toc-item');
        const headings = document.querySelectorAll('article h2');
        if (headings.length === 0) return;

        let activeSlug = '';
        headings.forEach((heading) => {
          const rect = heading.getBoundingClientRect();
          if (rect.top <= 150) {
            activeSlug = heading.id;
          }
        });

        tocItems.forEach((item) => {
          const slug = item.getAttribute('data-slug');
          if (slug === activeSlug) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });
      }

      // ---- Image lightbox ----
      function initLightbox() {
        const overlay = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
        const lightboxCaption = document.getElementById('lightbox-caption');
        const exitBtn = document.getElementById('lightbox-exit');

        if (!overlay || !lightboxImg || !lightboxCaption || !exitBtn) return;

        const images = document.querySelectorAll('#article-content img');
        images.forEach((img) => {
          img.classList.add('zoomable');
          img.addEventListener('click', () => {
            const imgEl = img as HTMLImageElement;
            lightboxImg.src = imgEl.src;
            lightboxImg.alt = imgEl.alt;

            // Build caption: "fig X. - alt text"
            const figNum = Array.from(images).indexOf(img) + 1;
            const altText = imgEl.alt || '';
            lightboxCaption.innerHTML = altText
              ? `<em>fig ${figNum}.</em> ${altText}`
              : '';

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
          });
        });

        function closeLightbox() {
          overlay?.classList.remove('active');
          document.body.style.overflow = '';
        }

        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) closeLightbox();
        });
        exitBtn.addEventListener('click', closeLightbox);
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeLightbox();
        });
      }

      // ---- Glossary term tooltips ----
      function initGlossaryTooltips() {
        // Convert any <a> inside article that has data-glossary into a tooltip
        const glossaryLinks = document.querySelectorAll('#article-content a[data-glossary]');
        glossaryLinks.forEach((link) => {
          const definition = link.getAttribute('data-glossary');
          if (!definition) return;

          link.classList.add('glossary-term');
          const tooltip = document.createElement('span');
          tooltip.className = 'glossary-tooltip';
          tooltip.innerHTML = `<strong>${link.textContent}</strong> - ${definition}`;
          link.appendChild(tooltip);
        });
      }

      // ---- Initialize everything ----
      function init() {
        updateScrollProgress();
        updateActiveTOC();
        initLightbox();
        initGlossaryTooltips();
      }

      window.addEventListener('scroll', () => {
        requestAnimationFrame(() => {
          updateScrollProgress();
          updateActiveTOC();
        });
      });

      init();

      // Re-init on Astro page transitions
      document.addEventListener('astro:page-load', init);
    </script>
  </body>
</html>
